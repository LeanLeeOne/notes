### 聚集索引和非聚集索引

<span style=background:#f8d2ff>聚集索引</span>和<span style=background:#ffb8b8>非聚集索引</span>均采用**B+**树的设计，其索引可分为2类：

1. #### 非聚集索引

   1. 叶节点<span style=background:#ffb8b8>不存储</span>数据，只存储数据记录的地址（主键），索引文件、数据文件相互独立。
   2. <span style=background:#ffb8b8>非聚族索引</span>也称<span style=background:#c2e2ff>辅助索引</span>、<span style=background:#c2e2ff>二级索引</span>。
   3. 使用<span style=background:#ffb8b8>非聚集索引</span>查询时，在查出**主键**后往往还需再去<span style=background:#f8d2ff>聚集索引</span>取出所需的字段，但如果令<span style=background:#ffb8b8>非聚集索引</span>直接覆盖所需的查询字段，这时就会直接返回结果，不会再去<span style=background:#f8d2ff>聚集索引</span>捞取，即<span style=background:#d4fe7f>索引覆盖</span>。
   4. **MyISAM**的索引均为<span style=background:#ffb8b8>非聚集索引</span>。
   
2. #### 聚族索引

   1. 叶结点<span style=background:#f8d2ff>存储</span>数据记录，索引文件、数据文件合二为一。
   2. **InnoDB**的主索引为<span style=background:#f8d2ff>聚族索引</span>，叶节点存储主键，所以主键不宜过大。
   3. 所谓聚族，是指按主键聚集，换句话说，其索引项只能为主键。

      1. 所以即便我们不显式指定主键，**InnoDB**也会自动选择一个可以唯一标识记录的列作为主键；
      2. 如果不存在这种列，**InnoDB**则会自动生成一列自增的6字节的长整型列作为隐式主键。
   4. <span style=background:#f8d2ff>聚集索引</span>最好选择自增整数作为主键，而非随机字符串，这样做能保证<span style=background:#c2e2ff>顺序追加</span>写入记录，减少对已有记录的移动，减少开销。但在[高并发写入时会](https://segmentfault.com/a/1190000022206424)导致<span style=background:#c9ccff>间隙锁</span>竞争问题，同时自增也是靠锁实现的，会降低写入性能、阻塞事务。



### 联合索引

<span style=background:#c2e2ff>联合索引</span>也称<span style=background:#c2e2ff>复合索引</span>，创建时[应遵循以下原则](https://www.cnblogs.com/softidea/p/5977860.html)：

1. <span style=background:#c2e2ff>联合索引</span>是按照“**最左原则**”进行匹配的，区分度越高的索引应越往左放，这样查询效率较高。
   1. 也可以参照`ORDER BY`或者`GROUP BY`中的字段顺序来设置<span style=background:#c2e2ff>联合索引</span>。
   2. `GROUP BY`本质上也会进行`ORDER BY`。
2. 尽量的扩展索引，不要新建索引。
3. 索引列不参与计算，否则成本高，效率低。<span style=background:#ffee7c>不是直接索引失效吗？</span>

而以下行为会违反了“**最左原则**”，令<span style=background:#c2e2ff>联合索引</span>失效：

1. 缺少左边的索引字段。
2. `ORDER BY`、`GROUP BY`中包含非索引字段，且非索引字段位于索引字段前面，[例子](https://blog.hufeifei.cn/2018/05/26/DB/MySQL性能优化[实践篇]-复合索引实例/#where-c1-x-and-c2-x-and-c4-gt-x-and-c3-x)。
3. 索引列的关系均为`AND`，`OR`[之后的条件不进行联合索引的匹配](https://segmentfault.com/q/1010000003984016/a-1020000003984281)。
4. 过滤条件中的[索引列遇到范围过滤](https://www.cnblogs.com/rjzheng/p/12557314.html)条件（`>`、`<`、`BETWEEN`、`LIKE`），会在该条件列上停止联合索引的向右匹配。

对<span style=background:#c2e2ff>联合索引</span>来说，`WHERE`中的`AND`和`IN`可以乱序使用，**Optimizer**会自动优化。

另外，**Optimizer**会根据[查询成本](https://blog.csdn.net/loongshawn/article/details/106470352)从一个表的多个索引中[自动选择](https://www.cnblogs.com/krisy/archive/2013/07/12/3186258.html)一个索引，对于<span style=background:#c2e2ff>联合索引</span>来说，**MySQL**只根据最左侧字段，所以有时**MySQL**选择的索引不是我们期望的、效率最高的索引。

另外，索引以及索引列的数量不是越多越好，也不是越少越好，讲究一个适中。索引是需要数据库不断进行维护的，索引数量越多，代表我们可以加速更多的查询，但同时增加维护开销，降低写入速度。

另外，对于值不重复的单字段、组合字段，我们可以建立<span style=background:#c2e2ff>联合索引</span>。**主键**的索引也可以看作<span style=background:#c2e2ff>联合索引</span>的一种。



### 索引失效

#### 在索引列上的任何操作

1. 包括：计算、函数、手动 / 自动转换类型。

#### 部分模糊搜索

1. 模糊搜索中的`LIKE '%*'`、`LIKE '%*%'` 
2. 但我们可以尽可能地达成<span style=background:#d4fe7f>索引覆盖</span>，让模糊搜索在经索引查询后的结果上生效，即曲线救国。
3. `LIKE '*%'`

#### NOT IN

`NOT IN`不走索引，可以改用`NOT EXISTS`。

#### 使用不等于

1. 不等于（`!=`、`<>`）不会使用索引，会全表扫描。
2. 可使用<span style=background:#d4fe7f>索引覆盖</span>曲线救国，或者改为`IN`、`BETWEEN`、`AND`代替。
3. `!=`与`<>`完全一致，只是`!=`是早期标准，`<>`是现行标准，推荐使用`<>`。
4. 有个例外是`<> NULL`。

#### NULL相关

1. `IS NULL`、`IS NOT NULL`、`<> NULL`会[根据成本决定是否使用索引](https://juejin.cn/post/6844903921450745863)。
2. <span style=background:#ffb8b8>非聚集索引</span>值可以为`NULL`，会放在索引文件最开始的地方。
3. **Optimizer**会判断<span style=background:#ffb8b8>非聚集索引</span>的扫描成本，包括读取索引记录的成本、回表（从<span style=background:#ffb8b8>非聚集索引</span>查出主键然后再去<span style=background:#f8d2ff>聚族索引</span>捞出完整记录）的成本。
4. 所以当`NULL`值占多数时，检索`NULL`时的回表成本会很高，趋向于全表扫描，**Optimizer**就不会对`IS NULL`使用索引，但此时会对`IS NOT NULL`、`<>`使用索引。

#### 字符串不加单引号

1. 确切地说是字面值为数字的字符串，不走索引的原因是`type`由`ref`退化成了`ALL`。

#### 联合索引的失效

1. 见上文，不赘述。



### 补充

#### 不适合使用索引的场景

在频繁更新（增删改）的字段、表上建立索引时要慎重。

#### 多表连接

1. `LEFT JOIN`，索引要添加到<span style=background:#c2e2ff>右</span>表的关联字段。
2. `RIGHT JOIN`，索引要添加到<span style=background:#c2e2ff>左</span>表的关联字段。

#### 其它索引

**InnoDB**还支持[哈希索引、全文索引、空间索引](https://www.cyc2018.xyz/数据库/MySQL.html#mysql-索引)。
