## 技巧

投递和项目经历相关的岗位，准备和应聘岗位相关中间件。

标准的面试内容包括：项目（适当美化）、八股文、算法题。

在面试时，可引导面试官，比如：

- 通过自我介绍来引导。
- 通过项目介绍来引导后续关于中间件的提问。



## 自我介绍

面试官好，我是李晓辉，来自山东，毕业自吉林大学，18年毕业之后就进入浪潮集团的公安事业部，从事相关系统的全栈开发。

疫情以来，部门的发展前景不明朗，工作内容也没有挑战性，人往高处走，所以我选择了离职换工作。

- 我认为自己的知识面比较广，但是深度不够，所以自七月离职以来，我将之前接触过的技术进行深入学习，积累了120篇、总计16万字的笔记。
- 当然，我的这些笔记多停留在理论层面，需要学习完善的地方还有很多。

我在工作期间负责轨迹刻画系统、公安搜索引擎等系统的研发。

- 对轨迹刻画系统投入的精力较多，除了前后端功能的开发，还对其表结构进行了优化，同时引入了**Kafka**，以及丰富了**Elasticsearch**的使用场景。
- 对搜索也有一定的了解。

以上便是我的自我介绍。

> - 不明朗：疫情以来，部门都没有接到新的正式的项目，只有公司内部使用的新闻类网站的开发、省应急厅这种与原有业务不相关的项目，以及旧项目的修修补补这类任务。而且不止疫情，部门业务线、组织结构的调整也是部门前景不明朗的原因。
> - 没有挑战性：相比于实习，以及刚入职时，那种经常学到新知识、攻克技术难点的工作状态，离职前的工作内容多是重复的脑力劳动、没有创造性。
> - 人往高处走：年轻人都有进互联网大厂的愿望，我也不例外，渴望进入大厂，与更优秀的人一起共事。当然，大厂对应聘者的要求也高，所以我也一直在提高自己的综合素质。



## 公安轨迹刻画系统 v2.0 v3.0

### <span style=background:#ffb8b8>项目简述</span>

- **产品描述：**轨迹系统就是将各类轨迹数据汇集、呈现、分析的系统。公安民警通过该系统来管控预测涉毒、前科、涉稳等各类重点人员的行踪。
- **技术选型：**该系统后台使用**HBase**存储海量轨迹记录，使用**Elasticsearch**索引点位资源、近期轨迹记录中，使用**Kafka**汇集分发数据，前台适配百度、高德、天地图等多种地图。
- **负责内容：**地图适配，微服务化改造，空间聚类算法的实现，将**Kafka**应用到系统（将预警的延迟由分钟降到了秒），冷热数据的分离。

### <span style=background:#ffb8b8>使用说明</span>

- #### 搜索

  - 从公安的各个业务系统中，将人员、车辆的各种轨迹，比如，铁路购票、旅馆住宿、卡口过车等原始数据，汇集到轨迹刻画系统的**HBase**中。
    - 我们几乎不生产数据，大部分时候都是数据的搬运工。

  - 民警通过通过车牌号、身份证号对**HBase**中轨迹数据进行搜索，搜索结果会通过在地图上画线描点的方式进行展示，此外还提供散点图、连线图等多种展现形式。

  - 同时，民警还可以直接在地图上绘制圆形、矩形、多边形，系统会基于**Elasticsearch**进行搜索区域搜索，将指定区域内的轨迹数据按时间倒序排列返回。

- #### 布控

  - 对指定人员（上访、在逃、前科、吸毒）设置监控，当他们到达某些地点是就会触发警报，通知民警。
  - 可以对人员的行为、地点进行过滤。

### <span style=background:#ffb8b8>架构设计</span>

- #### HBase行键

  - 从使用说明中可以看出，系统采用了以实体为中心的查询方式，同时会有时间范围这查询条件，所以对应的行键设计就采用了”省份证号+时间戳“这种设计方式。

  - 时间戳精确到毫秒或随机数以防止重复。

- #### HBase字段

  - 时间、地点（点位编号、点位名称、详细地址、经纬度）。

  - 行为类型、原主键、对象ID。

  - 扩展字段1（终端号、座次、房间号）、扩展字段2（始发地、上机时间、退宿时间）（有<span style=background:#d4fe7f>Mark Word</span>相似，复用数据结构）

- #### 微服务

  - 搜索：<u>以对象为中心的搜索</u>、<u>空间搜索</u>。

  - 分析：选择源头表、excel，然后拼装查询条件，动态生成SQL，执行并返回结果。

  - 系统：用户角色、权限、资源的管理。

### <span style=background:#ffb8b8>负责功能</span>
- #### HBase表结构的优化

  - 去除对象ID这一字段。

  - 将经纬度放入`site`列族。

  - 将始发地、目的地、过车速度等字段由扩展字段的方式改为自定义字段，充分利用**HBase**支持半结构化数据的特点。

- #### <span style=background:#19d02a>微服务化改造</span>⭐

  - 按照功能拆分为<u>搜索</u>、<u>分析</u>、<u>系统</u>三个子服务。

  - 主要是领导的决定，大胆拥抱新技术。

  - 微服务虽然是一项振奋人心、越来越流行的技术，微服务改造为我带来了一些收益，但实践过后，我个人感觉它不适合政务行业。

    - 性能

      - 单机架构对绝大部分政务行业的系统来说，足够了；单机不够，可采用<span style=background:#c2e2ff>Nginx+多机</span>的方式。
      - 服务之间通过网络进行通信，而非直接通过内存，增加了请求的时间、系统的复杂度。

    - 快速迭代

      - 公安网与互联网隔离，需要到客户现场部署、调试，不便于进行快速迭代，除非驻场开发（对公司来说成本高）。
      - <span style=background:#c9ccff>需求的快速响应、功能的快速开发、更新的快速上线倒是也适合政务行业。</span>范围小、低耦合。

    - 解耦

      - 就单体架构，也能通过编码层的封装进行解耦。
      - 微服务架构虽然解耦更彻底，但对于体量较小的应用，成本会高于收益。

    - 其他

      - 在单体架构能满足需要的场景下，微服务架构只会增加开发、调试、部署时的工作量。
      - 我们从改造的开始就陷入了为了微服务而进行微服务改造的方向，服务划分的粒度、服务集群中实例的数量，都没有很好地把控。
      - 新技术虽然好，但不应盲目追求。

      - 通过实践微服务，还是学到了很多，积累了系统设计的经验。

- #### Kafka

  - 将预警的延迟由分钟降到了秒。
    - 基于MQTT（订阅/发布）将信息发送到安卓应用，或者发送短信。

  - 使用**Kafka Connect**分发数据。

- #### 丰富Elasticsearch的使用场景

  - 搜索近期轨迹。

  - 使用别名，进行冷热数据分离。

- #### 聚类分析

  - 过滤套牌车。

  - DBSCN，具有噪声的基于密度的聚类方法。



## 公安大数据搜索引擎 v6.0

### <span style=background:#ffb8b8>项目简述</span>

- **产品描述：**该系统是一款面向公安面向多警种的搜索引擎，实现了海量数据的快速全文检索，人、车、案等对象档案的全面整合，同时提供用户行为分析、资源动态配置等功能。
- **技术选型：**该系统使用NLP解析用户搜索意图，基于**Elasticsearch**进行信息检索，使用**HBase**存储对象档案、主题信息，前端使用了**Vue**重构页面，后端使用了**Spring Cloud**对功能模块进行解耦。
- **负责内容：**微服务化改造（框架搭建、网关开发、链路追踪、配置管理），搜索引擎的开发，轨迹、关系等子系统的整合，用户并发访问调优。

### <span style=background:#ffb8b8>使用说明</span>

- 搜索+详情，从多张源头表抽取数据，根据身份证号、车牌号进行关联、存储为人员档案、车辆档案。
- 与公安业务耦合，不够通用。

### <span style=background:#ffb8b8>架构设计</span>

- #### 搜索

  - 该系统使用NLP解析用户搜索意图，基于**Elasticsearch**进行信息检索，基于**Elasticsearch**自身提供的文本相关度进行排序。

- #### 档案

  - 消除部门壁垒，跨警种。

  - 汇聚常住人口/流动人口、各类证件、工作单位、人际关系、轨迹、名下车辆、涉及案件等信息。

  - 以全量抽取+定期/定时维护的方式维护数据，通过身份证号（人）、车牌号（车）将各种数据进行关联，关联后的数据放入**HBase**中。

  - 采用将源头表作为列族名的设计，但是这一设计不合理，应使用列，而非列族。

### <span style=background:#ffb8b8>负责功能</span>

- #### 微服务

  - 框架搭建
    - **Dubbo**专注于服务治理，最初是自成体系，并且停止维护了一段时间，而**Spring Cloud**覆盖全面，所以选择了**Spring Cloud**。但这种认识是比较局限的，**Dubbo**对标的是**Spring Cloud Netflix**，两者功能大同小异，并且现在**Dubbo**也已集成**Spring Cloud**中，名为**Spring Cloud Alibaba**。
    - 配置提取，适配**Spring Boot**。

  - 将轨迹刻画、关系分析等子系统作为服务整合到搜索引擎中。
    - 搜索引擎与业务耦合，完全可以将其解耦，应用于轨迹刻画、关系分析等系统。

  - 网关开发：
    - 将瓦片路由的功能由**Tomcat**到**Nginx**到**Spring Cloud Gateway**，屏蔽掉瓦片服务器的具体地址，由网关进行统一代理。
    - 使用过滤器实现鉴权功能。
    - 熔断功能的开发：
      - 路由方案：失败的请求的URL的值变为了`Optional[forward:/defaultFallback]`，这根本没法用，故放弃“路由”方案。
      - 过滤器方案：基于网关提供的全局过滤器，对请求进行拦截，当连续请求失败，到达一定阈值时，就将服务下线；进行了改进，将粒度变细，由服务细化为服务的接口。

  - 链路追踪：使用**Sleuth**通过在HTTP请求头上添加Trace ID和Span ID，来跟踪请求，使用**Zipkin**配合**Logstash**收集日志，然后持久化到**Elasticsearch**中。

- #### 配置管理

- #### 用户行为分析

  - 埋点、收集用户点击事件、查询事件，未做进一步的分析。

  - 关联档案推荐。

- #### 性能优化

  - 云搜现在单机并发量是500并发，那如何提升至是5000并发呢？（高吞吐 = 低延迟 + 高并发）

  - 及时释放连接。

  - 多路复用。

  - 使用**Redis**提升响应速度。



## 挑战

### 线上故障

这倒没有，在交付前，我们都会进行充分的冗余设计、充分的测试来保证。

即便有，也可以结合日志、提交记录、堆快照等文件进行排查。

### 微服务化改造

- 从无到有，实践过程不顺利，微服务架构不适合政务行业。

- 调整了项目的打包方式来进行解决。

### Kafka Connect

- [HBase与ES的组合使用](https://jishuin.proginn.com/p/763bfbd59bff)：
  - 双读双写：原理简单；上游抵触、需自行实现，一致性难保证，**HBase**能扛得住、**Elasticsearch**不一定。
  - 自动复制：没有现成、需要自行开发，延迟较大。
  - 协处理器：加重**HBase**的负担，延迟较大，一致性难保证。
  - 消息队列：没有明显缺点，**Kafka**还提供了现成的组件。

- 从无到有，搜集资料、阅读源码、实践。
  - 关于主流数据源的资料比较全面，但是缺少关于**HBase**的资料，甚至**Apache**官网都没有提供。在一番搜索下，最终在其商业公司**Confluent**的官网上找到了相关Jar，从疑似开发者的博客中了解到向**HBase**中导入数据的过程。
  - 需要使用**KSQL**，**Kafka SQL**的意思。**Kafka**将自己定位为流处理工具，而非局限于消息队列，**KSQL**允许开发者以**SQL**的形式操纵**Kafka**中的数据流。需要使用**KSQL**将原始主题中的数据分别转换成适用于**HBase**、**Elasticsearch**的格式，即，**HBase**使用列族，有两层，**Elasticsearch**的坐标使用结构体。
    - 拼装行键。阅读、调试源码，中间还试图修改源码，但后来发现是自己没能理解设计者的意图，对使用方法进行了调整。先使用**Avro**生成**Schema**，再进行数据导入。
    - 当前版本的**Kafka**不支持**KSQL**中的结构体转换，幸运的是高版本支持。


