## 流

一个无限增长的数据集，叫做流式数据，简称流。

这类数据有以下特点：

- 无界：数据随时间的推移而不断加入。
- 事件：数据类型多为事件。
- 有序：事件的发生总是有时间先后顺序的。
- 不可变：事件一旦产生，就不能改变，只能通过发布新事件的方式进行弥补。
- 可重复结果：或者说是可重播。

### 流表二元性

表可以看作是流的当前状态、或结果，或者说流在某一时刻的状态便是表。

流始终将记录解释为`insert`，而表始终将记录解释为`upsert`。

### 流批二元性

流跟批的主要区别在于数据集是否有界，换句话说，有界流可以看作是批，无界批可以看作是流。



## 流式处理

流式处理，也叫做流式计算，指的是从流式数据中持续读取、处理、生成结果。

流处理是近实时，介于在线计算和离线计算之间。

流处理[是一种编程范式，介于](https://my.oschina.net/u/2424727/blog/2989115)“<span style=background:#c9ccff>请求/响应</span>”范式和“<span style=background:#c2e2ff>批处理</span>”范式之间。

> <span style=background:#c9ccff>请求/响应</span>：延迟低。>
> 流处理：延迟低。>
> <span style=background:#c2e2ff>批处理</span>：延迟高，吞吐高。
>
> 增加并行度是降低延迟并提高吞吐的主要方法。

### 图

流处理也使用DAG来描述处理过程：节点表示算子，边表示流向，有输入、输出。普通的流DAG称为逻辑流图（Logical Graph），包含分片/并行任务等执行详情的流DAG称为物理流图（Physical Graph）。

如下图所示，流处理包含`4`种分发策略。

- Forward：算子间的关系为一对一，往往由同一物理节点执行，以节省资源/减少开销。
- Broadcast：广播。
- Key-based：将Key相同的数据分发到同一任务中，以便聚合。
- Random：随机分发，以便<span style=background:#d4fe7f>负载均衡</span>。

<img src="../images/9/stream_date_exchange_strategies.png" style="zoom:50%;" />

### 状态

状态是指包含了历史事件的结果，状态包括计数器、累加器、缓存和窗口状态等。

自然的，有状态的操作需要历史事件，其分片和容错保证也更加复杂。

<span style=background:#c9ccff>Exactly Once</span>意味着计算需要支持有状态。

### 窗口

窗口是指从数据流中切分出来的有限数据集，其划分依据有个数（Count Window）和时间戳（Time Window）两种，当满足划分条件时，就会创建新的窗口并触发对旧窗口内数据的计算。

窗口可以滑动（Sliding Window），特别的，滑动距离等于窗口大小的窗口，或者说相互之间没有重叠的窗口，称为滚动窗口（Tumbling Window）。

窗口的大小一般是固定的，但也可以不固定，如基于用户会话的窗口（Session Window）。

#### 水位线

在流处理中，事件有发生时间、到达时间、处理时间。受网络延迟的影响，事件何时到达流处理系统是不可控的，会发生<span style=background:#c2e2ff>乱序</span>。窗口操作会缓冲/等待数据，对于有<span style=background:#c2e2ff>有序</span>要求的场景，可以通过排序来实现，但窗口不能无限缓冲/等待，于是便有了水位线（Watermark）机制。

Watermark是一个流处理系统自身的事件，它包含一个时间刻度`T`，当它出现在流中时，晚于`T`到达事件将会被忽略。Watermark是窗口操作中，平衡结果的准确性和延迟的主要方式。



## Backpressure

[Backpressure](https://www.zhihu.com/question/49618581/answer/237078934)是一种现象：当生产速度<span style=background:#c2e2ff>远</span>大于消费速度，导致**Consumer**的Buffer溢出。

发生Backpressure时，**Consumer**的唯一选择是丢弃事件，否则将面临崩溃。更好的做法是避免Backpressure的发生。



## 框架[[1]](https://www.cnblogs.com/duanxz/p/3639907.html)

- **Storm**
  - 低延迟。
  - 无状态设计。
  - 仅有记录记录确认机制，不提供<span style=background:#c9ccff>Exactly Once</span>。
  - 仅支持固定大小的窗口。
- **Spark Streaming**
  - 高延迟。
  - 在物化结果时不会将状态一并保存。
  - 提供<span style=background:#c9ccff>Exactly Once</span>。
  - 仅支持时间段划分窗口。
    - 窗口大小只能是检查点间隔的倍数。
    - 且不支持计数或会话的窗口。
- **Flink**
  - 低延迟。
  - 有状态。
  - 基于分布式快照提供<span style=background:#c9ccff>Exactly Once</span>。
  - 丰富的窗口。
- **Kafka Streams**
  - 低延迟。
  - 提供<span style=background:#c9ccff>Exactly Once</span>。



## 应用场景

### 单词统计

将文本按空格切分为单词，过滤停用词，然后统计词频。

### 股价统计

统计某支股票5秒钟内的交易次数、平均成交价、最高价、最低价。

### 点击事件分析

将用户基本信息、搜索信息进行管理，进而分析用户行为，决定推送内容。