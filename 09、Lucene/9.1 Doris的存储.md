## 简述

Doris的计算和存储是耦合的，而分离的两者更适应云服务。



## 列式存储

**Doris**采用列式存储（ORCFile），支持按列进行压缩，有效节省了IO、CPU。

除了压缩，**Doris**还会对数据排序，并在此基础上，按一定的粒度（一千行、一万行、十万行）创建稀疏索引，而多数分析型数据库只会直接创建稀疏索引。有序的数据，对于`min()`、`max()`、`sum()`等聚合操作，能有效缩小查询范围，提升读性能。

**Doris**的存储类似于SST（Sorted String Table）。



## 导入

**Doris**的数据导入是原子性的。

Label，用于唯一地标识一个导入任务，进而保证相同的Label仅会被成功导入一次。

### 导入类型

#### 流式导入

流式导入通过HTTP直接向**Doris**导入本地数据，不依赖其他系统或组件。

> 对于流式导入，文件大小控制在`10GB`以内，因为过大的文件会导致过大的失败重试代价。

流式导入是同步命令：返回成功，则表示数据已经导入；返回失败，则表示数据没有导入。

#### Broker导入

Broker导入通过部署的Broker进程，读取外部存储上的数据进行导入。

Broker导入是异步命令：命令执行成功，只表示提交任务成功；导入是否成功，需要通过`SHOW LOAD`来查看。

### 原子性

https://doris.apache.org/zh-CN/docs/dev/data-operate/import/import-scenes/load-atomicity

### Compaction

合并

#### Aggregate模型

在导入数据时，Aggregate模型会进行分级合并，即，把小文件合并成中文件，再把中文件合并成大文件，而没有采用大文件直接跟小文件合并的方式，因为后者存在更严重的读写放大。

在Aggregate模型中，数据聚合发生在`3`个阶段：

1. 每一批次数据导入的ETL阶段，都会对同一批次内的数据进行聚合。
2. <span style=background:#f8d2ff>Backend</span>进行Compaction时，会对已导入的不同批次的数据进行进一步的聚合。
3. 数据查询阶段，对于涉及到的数据，会进行对应的聚合。

数据的聚合程度，在不同时间可能不一致，但这对用户而言是透明的，因为**Doris**会在查询过程中自动加入聚合算子，来提供最终的聚合结果，即，保证对外展示的一致性。

> 但这种一致性保证，会在语义和性能方面存在[局限性](https://doris.apache.org/zh-CN/docs/dev/data-table/data-model#聚合模型的局限性)：
>
> - 在Aggregate模型的聚合列（Value）上，执行与聚合类型不一致的聚合类查询时，要注意语义。
> - 在某些查询中，这种一致性保证会极大地降低查询效率，例如`count(*)`查询时，**Doris**必须扫描所有的Key字段，并且经过聚合，才能得到正确的语义。对于频繁的`count(*)`查询，官方建议通过增加一个聚合类型为`SUM`/`REPLACE`、值恒为`1`的字段来模拟`count(*)`。

对于`REPLACE`这种聚合方式：

- 对于同一个导入批次中的数据，替换顺序不做保证。
- 对于不同导入批次中的数据，替换顺序可以保证，即，后一批次的数据会替换前一批次的。

#### Unique模型

Unique模型的MOW，在导入阶段就会将被覆盖/更新的数据标记为删除，这样在查询时，所有被标记删除的数据都会在文件级别被过滤掉，即，消除掉了MOR中的数据聚合过程、读取出来的数据都是最新的，并且能够在多种情况下（尤其是聚合查询）支持多种谓词的下推，大幅提升查询性能。



## ENGINE

本示例中，ENGINE 的类型是 olap，即默认的 ENGINE 类型。在 Doris 中，只有这个 ENGINE 类型是由 Doris 负责数据管理和存储的。其他 ENGINE 类型，如 mysql、broker、es 等等，本质上只是对外部其他数据库或系统中的表的映射，以保证 Doris 可以读取这些数据。而 Doris 本身并不创建、管理和存储任何非 olap ENGINE 类型的表和数据。



## 冷热分离

**Doris**能自动识别冷热数据，减少不必要的重复BE/CE，节省IO、CPU。**Doris**能识别存储介质的类型（HDD或SSD），结合自动识别冷热数据，能在分区粒度上，自动进行冷热数据的迁移。

