[不可不说的Java“锁”事](https://tech.meituan.com/2018/11/15/java-lock.html)

​	作者：美团技术团队

[Java锁杂谈](https://www.zhihu.com/question/317687988/answer/1715863550)

[How to do distributed locking?](https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html)

<span style=background:#ffee7c>[Java的3种并发控制工具：CountDownLatch、CyclicBarrier和Semaphore](http://blog.sina.com.cn/s/blog_7d1968e20102xewm.html)</span>





### 并发读写

1. **ReadWriteLock**

2. 1. **ReadWriteLock**是一种悲观锁，允许在没有写入时，多个线程并发读；但在读时不允许写入。
   2. **ReadWriteLock**适合读多写少的场景。
   3. 在创建**ReadWriteLock后，**需要先获取读锁或写锁，然后才能加锁，如，<span style=background:#b3b3b3>ReadWriteLock.readLock().lock()</span>。

3. **StampedLock**

4. 1. **StampedLock**是一种乐观锁，于Java 8引入，也用于并发读写，它与**ReadWriteLock**的最大不同在于<u>支持读时写入</u>。
   2. <u>支持读时写入</u>意味着读取的数据可能不一致，所以**StampedLock**需要额外检测数据是否一致，若不一致则将乐观读升级为悲观读。
   3. **StampedLock**的写锁不可重入，读锁可重入。

5. ```java
   // StampedLock的使用说明：
   long stamp = stampedLock.tryOptimisticRead(); // 加乐观锁
   …… // 读取
   if(!stampedLock.validate(stamp)){ // 检测数据是否一致
       stamp = stampedLock.readLock(); // 升级为悲观锁
       try{
           …… // 重新读取
       }finally{
           stamped.unlockRead(stamp); // 解锁
       }
   }
   …… // 业务代码
   ```

6. 

### 锁的分类

1. 共享锁和排他锁。

2. 1. **共享锁**，即**读锁**，允许并行读，不允许写。
   2. **独占锁**，即**写锁**，也称**排他锁**，串行读写。
   3. 在数据库中有所应用。

3. 乐观锁和悲观锁。

4. 1. **乐观锁**，认为读的过程中大概率不会有写，基于CAS。
   2. **悲观锁**，认为读的过程中有写，写入需要等待读取完成。
   3. 在数据库中有所应用。

5. 公平锁和非公平锁。

6. 1. 公平与否的标准在于是否允许插队。
   2. 插队能提高效率。

7. 可重入锁和不可重入锁。

8. 1. 可重入的意思是允许同一持锁者重复加锁，不会产生死锁。

9. 偏向锁、轻量级锁、重量级锁。



### 死锁

当多个线程持有不同的锁，并试图获取对方已持有的锁时，就会无限等待，即死锁。

多线程按照统一的顺序获取锁，能防止死锁。