## 简述

<span style=background:#c9ccff>调用</span>包括<span style=background:#c9ccff>请求</span>、<span style=background:#c9ccff>响应</span>两步。

如[下图](http://www.ityouknow.com/springcloud/2018/02/02/spring-cloud-sleuth-zipkin.html)所示，在分布式系统中，前端的一次<span style=background:#c9ccff>调用</span>往往会形成对后端的多个服务<span style=background:#c9ccff>调用</span>，并形成<u>调用链路</u>。

- 通过追踪<span style=background:#c9ccff>调用</span>，可获取<u>调用链路</u>，进而得到服务之间的依赖关系。
- 更进一步，在追踪的同时：
  - 记录各个<span style=background:#c9ccff>调用</span>的发出/接收时间，即可得到其在各个服务上的耗时，进而分析性能、改进响应速度。
  - 记录各个<span style=background:#c9ccff>调用</span>的成功/失败，即可定位故障。

<u>调用链路</u>也叫做Trace，<u>调用链路</u>中的子调用也叫做Span，两者均用Id进行标识。

> Cloud Native Computing Foundation，CNCF，为了实现平台无关、厂商无关的<span style=background:#c2e2ff>链路追踪</span>，发布了<span style=background:#c2e2ff>链路追踪</span>标准Open Tracing。

![](../images/6/request-response-tracing.png)



## Zipkin

[Zipkin](https://github.com/openzipkin/zipkin)是一个分布式<span style=background:#c2e2ff>链路追踪</span>系统，由Twitter基于Google的Dapper论文开发。

**Zipkin**的工作流程分为3部分：

1. ##### 生产记录

   1. **Zipkin**可用于多线程、RPC、HTTP等调用过程。
   2. 当应用系统接收到请求时，**Zipkin**会为请求赋予一个全局唯一的<u>Trace ID</u>。

2. ##### 收集记录

   1. 可以通过**HTTP**将记录异步发送给**Zipkin**，之后持久化到**MySQL**、**Elasticsearch**等数据库中。
   2. 也可以通过写本地日志，使用**Logstash**等日志收集工具进行收集，最后持久化到**MySQL**、**Elasticsearch**中。

3. ##### 记录查询展示

   1. 通过追踪<u>Trace ID</u>即可呈现整个调用链。

**Zipkin**的<u>Trace ID</u>采用`ThreadLocalRandom`类来生成的。

### 收集数据

向**Zipkin**报告数据的方式有同步、异步两种：

- 同步：主要是通过HTTP。
- 异步：主要是通过**Kafka**，当然也可以使用**Apache ActiveMQ**、**gRPC**和**RabbitMQ**。

### 存储数据

**Zipkin**提供了插拔式的数据存储，包括In-Memory、MySQL、Cassandra、Elasticsearch。



## Sleuth

**Zipkin**提供了Java版本的埋点库[Brave](https://github.com/openzipkin/brave)，而[Spring Cloud Seluth](https://github.com/spring-cloud/spring-cloud-sleuth)通过自动化配置对Brave进行了整合。

RestTemplate

**Sleuth**会在通过在HTTP<u>请求头</u>上添加<u>Trace ID</u>和<u>Span ID</u>，：

1. <u>Span ID</u>表示基本的工作单元，如，发送HTTP请求。
2. <u>Trace ID</u>包含一组<u>Span ID</u>，形成树状结构。
3. 当一个服务调用另一个服务时，<u>Trace ID</u>将保持不变。



## Sleuth与Zipkin

**Sleuth**可与**Zipkin**搭配使用，其[大概流程](https://www.jianshu.com/p/092c43485637)为：

- **Sleuth**截获HTTP调用，然后将<u>Trace ID</u>和<u>Span ID</u>添加到<u>请求头</u>中。
- 服务接收到HTTP请求后，将数据异步发送到**Zipkin**。
- **Zipkin**将收集的日志持久化到**MySQL**、**Elasticsearch**中。

> 也可以使用Beats，一个简单的数据传送器。Beats要么位于服务器上，要么位于容器上，用于监听日志文件的位置，然后将日志发送到**Logstash**中进行转换，或直接发送到**Elasticsearch**中。

###  配置

```yml
spring:
  zipkin:
    base-url: http://localhost/ # 地址
    sender:
      type: web 				# RabbitMQ、Kafka、Web
  sleuth:
    sampler:
      probability: 1.0	 		# 采样比例，0~1.0，默认为0.1
```

更多实战见：

https://www.cnblogs.com/duanxz/p/7552857.html

https://blog.csdn.net/qq_21387171/article/details/53787019
