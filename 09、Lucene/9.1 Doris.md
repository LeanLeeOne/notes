## 简述

**Doris**是一个基于MPP架构的高性能、实时的分析型数据库，能提供毫秒级的大数据查询，不仅支持高并发的点查询场景，也支持高吞吐的复杂分析场景。

> **Doris**由百度于2017年开源，2018年捐赠给Apache，2022年成为Apache的顶级项目。
>
> **Doris**采用**MySQL**协议，支持标准SQL，高度兼容**MySQL**语法。



## 数据模型

**Doris**的数据模型源自Google Mesa，分为`3`种：

- Aggregate Key：会自动地按Key对数据进行聚合，这种预聚合能大幅提升读性能。
- Unique Key：Key唯一，相同Key的数据会被覆盖，但不会聚合，适用于行级更新。
- Duplicate Key：原样存储，既不根据Key进行覆盖，更不会根据Key进行聚合，适用于事实表的明细存储。

> 严格来说，Duplicate Key会进行排序，不是原样存储。

Aggregate Key模型，在导入数据过程中，会进行分级合并，即，把小文件合并成中文件，再把中文件合并成大文件，而没有采用大文件直接跟小文件合并的方式，因为后者存在更严重的读写放大。

> **Doris**的数据导入是原子性的。



## 查询引擎

<img src="../images/9/doris_framework.png" style="zoom: 40%;" />

如[上图](https://doris.apache.org/zh-CN/docs/dev/summary/basic-summary/)所示，**Doris**的进程仅分为`2`类，不依赖**Hadoop**等外部组件，两类进程均支持横向扩展：

- 管理节点，<span style=background:#ffb8b8>Frontend</span>，主要负责用户请求的接入、生成<u>执行计划</u>、元数据的管理、节点管理相关工作。
  - 对于元数据的管理，<span style=background:#ffb8b8>Frontend</span>采用了类似于**ZooKeeper**的设计，将节点分为Leader、Follower和Observer等三种角色。至少部署`3`个Follower，才能实现元数据的读写高可用。

- 工作节点，<span style=background:#f8d2ff>Backend</span>，主要负责执行计算、存储数据。
  - 从节点又分为Coordinator和Worker。

两类进程通过一致性协议来保证服务的高可用和数据的高可靠。

**Doris**的查询引擎[源自](https://www.infoq.cn/article/vxup94ub59ya*k0tnefe)**Impala**。

- **Impala**采用多主模式，每个节点都缓存元数据，而这可能会面临元数据落后/不一致的问题。
- **Doris**采用主从模式，将元数据的管理放到主节点中，从而避免了元数据的不一致。

除了采用了与**Impala**不同的主从模式，**Doris**还将**Statestored**、**Catalogd**的功能也整合进了<span style=background:#ffb8b8>Frontend</span>中，从而实现了不依赖**Hadoop**等外部组件，部署、扩展更加简便。

**Impala**由**Hive**的Metastore保证数据的一致性，由**HDFS**保证数据的可靠性；而**Doris**自行实现：采用**Paxos**协议来保证一致性，采用Memory + Checkpoint + Journal的机制来确保元数据的高性能及高可靠。

**Doris**查询引擎的所有的内存结构能够按照列式布局，是向量化的。

> 对于行式布局，每一次对行的函数调用，都会：打断CPU流水，不利于分支预测；指令和数据Cache Miss高；编译器不友好，不利于循环展开，不利于使用SIMD等CPU加速指令。
> 但对于列存布局，能采用向量化执行，从而大幅减少虚函数调用、提升Cache命中率、高效利用SIMD指令、提升CPU利用率。
> 在宽表聚合场景下，向量化引擎的性能是非向量化引擎的`5`~`10`倍。

**Doris**采用了Adaptive Query Execution技术， 可根据Runtime Statistics来动态调整执行计划。

**Doris**使用CBO和RBO结合的优化策略。

> RBO，Rule Based Optimizer，支持常量折叠、子查询改写、谓词下推、列裁剪、分区分桶裁剪、等价谓词推导、公共表达式复用等。
> CBO，Cost Based Optimizer，支持Join Re-Order。CBO还在优化中，通过更加精准的统计信息收集和推导，提供更加精准的代价模型预估。



## 存储

**Doris**采用列式存储（ORCFile），支持按列进行压缩，有效节省了IO、CPU。

除了压缩，**Doris**还会对数据排序，并在此基础上，按一定的粒度（一千行、一万行、十万行）创建稀疏索引，而多数分析型数据库只会直接创建稀疏索引。有序的数据，对于`min()`、`max()`、`sum()`等聚合操作，能有效缩小查询范围，提升读性能。

**Doris**支持强一致、自动更新的物化视图。

**Doris**能自动识别冷热数据，减少不必要的重复BE/CE，节省IO、CPU。**Doris**能识别存储介质的类型（HDD或SSD），结合自动识别冷热数据，能在分区粒度上，自动进行冷热数据的迁移。

> Doris的计算和存储是耦合的，而分离的两者更适应云服务。